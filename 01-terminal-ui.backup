#!/usr/bin/env raku

use Terminal::UI 'ui';

# find all Unicode marks
# for ^0x10FFFF {
#   if .chr ~~ / <:M> / {
#     say .base(16) ~ ': ' ~ ('o' ~ .chr);
#   }
# }
# die;

my @mark = "mark.txt".IO.lines.map({ ('0x' ~ .split(':')[0]).Int });

ui.setup(:1panes);

my @latent = "latent".comb.map({ [.ord,] });
my @ville = "ville".comb.map({ [.ord,] });

sub accumulate(@list) {
  my $n = ^@list .pick;
  @list[$n].push(@mark.pick);
}

sub shuffle(@list) {
  my $n = ^@list .pick;
  return unless @list[$n].elems > 2;
  @list[$n] = [@list[$n][0], |@list[$n][1..*].pick(*)];
}

sub decrease(@list) {
  my $n = ^@list .pick;
  return unless @list[$n].elems > 1;
  @list[$n].pop;
}

loop {
  my $latent = [~] @latent.map({ [~] .map(*.chr) });
  my $ville = [~] @ville.map({ [~] .map(*.chr) });
  ui.panes[0].splash( "$latentâ€¢$ville" );
  given ui.get-key {
    when /q/ { last }
    when /a/ {
      accumulate @latent;
      accumulate @ville;
    }
    when /s/ {
      shuffle @latent;
      shuffle @ville;
    }
    when /d/ {
      decrease @latent;
      decrease @ville;
    }
  }
}

ui.shutdown;
